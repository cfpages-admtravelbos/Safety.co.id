name: Update Clients v.8

on:
  push:
    paths:
      - .clients
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_html_files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Check if .clients file exists
        id: check_clients
        run: if [[ -f .clients ]]; then echo "exists=true" >> $GITHUB_ENV; else echo "exists=false" >> $GITHUB_ENV; fi

      - name: Abort if .clients file does not exist
        if: env.exists == 'false'
        run: echo "No .clients file found, aborting operation." && exit 1

      - name: Check if .clients file is empty
        if: env.exists == 'true'
        run: |
          if [[ ! -s .clients ]]; then
            echo "File is empty, nothing to do." && exit 0
          fi

      - name: Determine variable from .clients
        if: env.exists == 'true'
        run: |
          LINE=$(cat .clients)
          WAURL="" PHURL="" NAME="" PHONE=""
          IFS='|' read -ra PARTS <<< "$LINE"
          for PART in "${PARTS[@]}"; do
            if [[ $PART == https://* ]]; then
              [[ $PART == *:speech_balloon:* ]] && WAURL=$PART || PHURL=$PART
            elif [[ $PART =~ ^[0-9\ ]+$ ]]; then
              PHONE=$PART
            else
              NAME=$PART
            fi
          done
          echo "Extracted values: WAURL=${WAURL}, PHURL=${PHURL}, NAME=${NAME}, PHONE=${PHONE}"
          echo "WAURL=$WAURL" >> $GITHUB_ENV
          echo "PHURL=$PHURL" >> $GITHUB_ENV
          echo "NAME=$NAME" >> $GITHUB_ENV
          echo "PHONE=$PHONE" >> $GITHUB_ENV

      - name: Update Clients
        if: env.exists == 'true'
        run: |
          for file in $(find . -name '*.html'); do
            echo "Processing $file"
            cp "$file" "${file}.bak"
            echo "Current spans in $file:"
            grep -A 2 -B 2 '<span' "$file"

            echo "Attempting to replace span text in: $file"
            sed -i -E "s@(<span[^>]*>)\s*\d{1,4} \d{1,4}( \d{1,4})? *\([^\)]+\)\s*(</span>)@\1${PHONE} (${NAME})\4@" "$file"

            if ! diff -q "${file}.bak" "$file"; then
              echo "Changes detected in $file:"
              diff "${file}.bak" "$file"
            else
              echo "No changes detected in the content of $file after sed."
            fi
          done
      
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git diff --name-only
          if ! git diff --quiet; then
            git add .
            git commit -m "Update URLs: WAURL: ${WAURL}, PHURL: ${PHURL}, Phone: ${PHONE}, Name: ${NAME}"
            
            # Push changes
            git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi
